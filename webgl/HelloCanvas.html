<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>^-^</title>
  </head>
 
  <body onload="main()">
    <canvas id="webgl" width="400" height="400">
    Please use a browser that supports "canvas"
    </canvas>

    <script src="./lib/webgl-utils.js"></script>
    <script src="./lib/webgl-debug.js"></script>
    <script src="./lib/cuon-utils.js"></script>
    <script src="./lib/cuon-matrix.js"></script>
    <script>
      function main () {
        let vShader = `
          attribute vec4 a_Position;
          uniform vec4 u_Translation;
          uniform mat4 u_xformMatrix;

          void main () {
            gl_Position = u_xformMatrix * a_Position;
          }
        `

        let fShader = `
          precision mediump float;
          uniform vec4 u_FragColor;

          void main () {
            gl_FragColor = u_FragColor;
          }
        `

        const canvas = document.getElementById('webgl')

        const gl = getWebGLContext(canvas, true)

        gl.clear(gl.COLOR_BUFFER_BIT)
        gl.clearColor(0, 0, 0, .5)

        initShaders(gl, vShader, fShader) // 此处创建gl.program

        let u_FragColor = gl.getUniformLocation(gl.program, 'u_FragColor')
        gl.uniform4fv(u_FragColor, [Math.random(), Math.random(), Math.random(), 1])
        
        let u_Translation = gl.getUniformLocation(gl.program, 'u_Translation')
        gl.uniform4fv(u_Translation, [0.5, 0.5, 0.0, 0.0])

        let u_xformMatrix = gl.getUniformLocation(gl.program, 'u_xformMatrix')

        let ANGLE = -90.0

        // 缩放
        let xformMatrix = new Matrix4()

        let lastTime = Date.now()

        let ANGLE_STEP = 10

        tick()

        function tick () {
          // if (ANGLE >= 90) {
          //   cancelAnimationFrame(tick)
          //   return
          // }

          animate(ANGLE += 1)

          requestAnimationFrame(tick)
        }

        function animate (angle) {
          gl.clear(gl.COLOR_BUFFER_BIT)

          xformMatrix.setRotate(angle, 0, 0, 1)
          gl.uniformMatrix4fv(u_xformMatrix, false, xformMatrix.elements)

          let n = initVertexBuffers(gl)
          gl.drawArrays(gl.TRIANGLE_FAN, 0, n)
        }
      }

      function initVertexBuffers (gl) {
        let vertices = new Float32Array([
          -0.5, 0.5,
          -0.5, -0.5,
          0.5, 0.5,
          0.5, -0.5
        ])

        // console.log(vertices)

        let n = 3

        let vertextBuffer = gl.createBuffer()

        gl.bindBuffer(gl.ARRAY_BUFFER, vertextBuffer)
        gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW)

        let a_Position = gl.getAttribLocation(gl.program, 'a_Position')

        gl.vertexAttribPointer(a_Position, 2, gl.FLOAT, false, 0, 0)
        gl.enableVertexAttribArray(a_Position)

        return n
      }
    </script>
  </body>
</html>
