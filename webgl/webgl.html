<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>webgl</title>
  <style>
    #canvas {
      background: #ccc;
    }
  </style>
</head>
<body>
  <canvas id="canvas" width="300px" height="300px"></canvas>
</body>
</html>

<script src="https://webglfundamentals.org/webgl/resources/webgl-utils.js"></script>
<script id="2d-vertex-shader" type="x-shader/x-vertex">
  // 属性变量
  // attribute vec4 a_position; // 需要分号
  attribute vec2 a_position;

  uniform vec2 u_resolution;

  void main () {
    // gl_Position = a_position; // P大写

    vec2 zeroToOne = a_position / u_resolution;

    vec2 zeroToTwo = zeroToOne * 2.0;

    vec2 clipSpace = zeroToTwo - 1.0;

    gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
  }
</script>

<script id="2d-fragment-shader" type="x-shader/x-fragment">
  precision mediump float;

  uniform vec4 u_color;

  void main () {
    gl_FragColor = u_color;
  }
</script>

<script type="text/javascript">
  function main () {
    let canvas = document.getElementById("canvas")
    let gl = canvas.getContext("experimental-webgl")

    let program = webglUtils.createProgramFromScripts(gl, ['2d-vertex-shader', '2d-fragment-shader'])

    let positionAttributeLocation = gl.getAttribLocation(program, 'a_position')

    let positionBuffer = gl.createBuffer()
    gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer)

    let resolutionUniformLocation = gl.getUniformLocation(program, "u_resolution") // 获取全局变量uniform的位置
    let colorUniformLocation = gl.getUniformLocation(program, 'u_color')

    webglUtils.resizeCanvasToDisplaySize(gl.canvas)

    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height)

    gl.clearColor(0, 0, 0, 0)
    gl.clear(gl.COLOR_BUFFER_BIT)

    gl.useProgram(program)
    gl.enableVertexAttribArray(positionBuffer)

    // gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer)

    let size = 2
    let type = gl.FLOAT
    let normalize = false
    let stride = 0
    let offset = 0
    gl.vertexAttribPointer(positionAttributeLocation, size, type, normalize, stride, offset)

    gl.uniform2f(resolutionUniformLocation, gl.canvas.width, gl.canvas.height)

    for (let i = 0; i < 50; i ++) {
      setRectangle(gl, randomInt(300), randomInt(300), randomInt(300), randomInt(300))

      gl.uniform4f(colorUniformLocation, Math.random(), Math.random(), Math.random(), 1)

      gl.drawArrays(gl.TRIANGLES, 0, 6)
    }
  }

  function randomInt (range) {
    return Math.floor(Math.random() * range)
  }

  function setRectangle (gl, x, y, width, height) {
    let x1 = x
    let x2 = x1 + width
    let y1 = y
    let y2 = y + height

    let positions = [
      x1, y1,
      x2, y1,
      x2, y2,
      x2, y2,
      x1, y1,
      x1, y2
    ]

    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW)
  }

  main()

</script>